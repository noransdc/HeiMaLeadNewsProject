# 文章审核 – 定时任务调度设计





#### 一、整体流程

文章提交后，由文章服务向 schedule 服务发起任务创建请求。
 schedule 服务在 task 表中新增调度任务，并将文章的 `publishTime` 映射为任务的 `executeTime`，实现业务时间与调度时间的解耦。

schedule 服务通过定时任务扫描可执行任务，逐条通知文章服务进行审核。
 文章审核完成后更新文章状态，schedule 服务根据远程调用结果更新 task 状态。

为避免异常情况下任务丢失，schedule 服务会周期性扫描文章表中“待审核”的数据，与 task 表进行对比并补偿缺失任务。



#### 二、schedule 服务任务执行机制

**1. 可执行任务条件**

- 状态为 `INIT`
- 或状态为 `FAIL` 且 `retry_count < max_retry`

------

**2. 任务抢占与并发控制**

- 使用 `SELECT … FOR UPDATE SKIP LOCKED` 查询可执行任务
- 在同一事务中将任务状态批量更新为 `RUNNING`
- 通过数据库行级锁实现任务抢占，避免多实例重复执行

------

**3. 任务执行与超时控制**

- 使用线程池异步执行任务
- 通过 Feign 同步调用文章审核接口
- 调用方（schedule）配置 `readTimeout = 5s`：
  - 覆盖审核流程中第三方 HTTP 请求的正常耗时
  - 同时避免调度线程被异常流程长期阻塞

------

**4. 任务状态更新策略**

任务状态更新通过以下三类方法完成：

- `markSuccess`
- `markFailRetryable`
- `markFailUnrecoverable`

所有状态更新 SQL 均以 `status = RUNNING` 作为前置条件，确保幂等性，防止重复执行或并发覆盖。

- 成功时清空 `error_msg`
- 不重置 `retry_count`，该字段用于记录历史失败次数



#### 三、文章审核设计

1. 审核方法提供明确返回值，由文章核心服务主动调用并处理结果，避免服务反向调用，降低耦合。
2. 审核前判断文章当前状态是否仍为“待审核”，对重复调用进行幂等短路。
3. 文章状态更新严格遵循状态机约束，防止非法状态迁移。

------

#### 四、异常与兜底说明

- 调度过程中可能因进程异常、超时等原因产生 RUNNING 状态的历史脏任务
- 通过任务补偿机制与 retry 上限控制，保证系统最终一致性，不影响主流程稳定运行





你这个文章审核的定时任务是怎么做的？

> 我们文章审核是通过一个独立的 schedule 服务来做的调度。
>  文章提交后，文章服务会向 schedule 服务创建一个调度任务，把文章的发布时间映射成任务的 executeTime。

> schedule 服务通过定时任务扫描可执行任务，筛选状态为 INIT，或者失败但还没超过重试次数的任务。
>  查询时使用 `for update skip locked`，在同一事务里先把任务状态改成 RUNNING，确保多实例下同一任务只会被一个节点执行。

> 任务执行时，通过线程池同步调用文章服务的审核接口。
>  调用方配置了 Feign 超时，大概 5 秒，用来覆盖审核过程中第三方 HTTP 请求的正常耗时，同时避免调度线程被拖死。

> 任务状态更新分为成功、可重试失败和不可恢复失败，所有更新都要求任务当前状态必须是 RUNNING，保证幂等。
>  成功后会清空 error_msg，但 retry_count 会保留，作为历史失败记录。

> 在文章服务侧，审核方法本身是幂等的，会先判断文章是否仍是待审核状态，避免因为重试或超时导致重复执行。
>  另外 schedule 服务还有一套补偿机制，定期扫描待审核文章，补偿可能丢失的任务，保证最终一致性。



1：为什么不用 MQ 或延迟队列？

这个场景对实时性要求不高，但对可控性和一致性要求高。
 数据库 + 定时扫描在可控复杂度下已经能保证不丢任务、可重试、可补偿，优先选用更简单、可调试的方案。



2：`for update skip locked` 的作用是什么？

用来实现任务抢占。
 查询即加行锁，并跳过已经被其他事务锁住的任务，避免多实例并发执行同一任务。



3：为什么要先把任务改成 RUNNING 再执行？

这是为了保证“拿到任务”和“标记占用”是原子的。
 如果先执行再更新状态，在并发或异常情况下容易导致重复执行。



4：Feign 超时为什么配在调用方？

超时是调用方的自我保护策略。
 被调用方只能控制自己的执行逻辑，无法决定调用方愿意等多久。



5：如果任务已经执行成功，但调用方超时了怎么办？

文章审核接口是幂等的，会先判断文章是否仍是待审核状态。
 即使 schedule 重试调用，也只会做一次真实业务处理，最终状态能收敛一致。

